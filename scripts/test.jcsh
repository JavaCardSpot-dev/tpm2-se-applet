# disable echoing of script commands
/mode echo off
# enable APDU tracing
/mode trace on

# to print SW, use following command: /echo ${response;s$(/expr ${response;l} - 4),4}

/echo "SELECT CARDLET"
/echo
/select |TPMApplet
/echo

# Response codes
TPM_RC_SUCCESS=0000
TPM_RC_COMMAND_CODE=0143 	# Wrong code
TPM_RC_COMMAND_SIZE=0142 	# Wrong size
TPM_RC_BAD_TAG=001E 		# Wrong tag

# Constants
TPM_ST_NO_SESSIONS=8001
TPM_ST_SESSIONS=8002
TPM_SU_CLEAR=0000

# Selected crypto algorithms
TPM_ALG_ERROR=0000
TPM_ALG_FIRST=0001
TPM_ALG_RSA=0001
TPM_ALG_SHA=0004
TPM_ALG_SHA1=0004
TPM_ALG_HMAC=0005
TPM_ALG_AES=0006
TPM_ALG_XOR=0x000A
TPM_ALG_SHA256=000B
TPM_ALG_SHA384=000C
TPM_ALG_SHA512=000D
TPM_ALG_NULL=0010
TPM_ALG_LAST=0044

/echo
/echo "**************************"
/echo "* INS: 44, Startup TPM   *"
/echo "**************************"
/echo

# TPM command:
TAG=${TPM_ST_NO_SESSIONS}
cSIZE=09
TPM_CC=00000144 
cCODE=${TPM_CC}
sTYPE=${TPM_SU_CLEAR}

INS=44
aSIZE=09
/echo "APDU:"
/echo "             CLA INS P1 P2 Lc             Le" 
/echo " - send:     00  44  00 00 09 TPM Command 05"
/send 00${INS}0000${aSIZE}${TAG}${cSIZE}${cCODE}${sTYPE}05 *9000
/echo
/echo "Response:"
/echo " -  tag: ${response;s0,4}"
/echo " - size: ${response;s4,2}"
/echo " - code: ${response;s6,4}"
/echo

/echo
/echo "**************************"
/echo "* INS: 82, Extend PCR    *"
/echo "**************************"
/echo

# Command:
# **************************************************************************
# Type						Name					Description
# **************************************************************************
# TPMI_ST_COMMAND_TAG		tag	
# UINT32					commandSize	
# TPM_CC					commandCode				TPM_CC_PCR_Extend {NV}
# TPMI_DH_PCR+				@pcrHandle				handle of the PCR
# 													Auth Handle: 1
#													Auth Role: USER
# TPML_DIGEST_VALUES		digests					list of tagged digest values to be extended

# Response:
# **************************************************************************
# Type						Name					Description
# **************************************************************************
# TPM_ST					tag						see clause 8
# UINT32					responseSize
# TPM_RC					responseCode

# TPM command:
TAG=${TPM_ST_NO_SESSIONS}
cSIZE=2B 							# 43
TPM_CC=00000182 
cCODE=${TPM_CC}
pcrHandle=01						# PCR_O1
count=01							# One digest
hashAlg=${TPM_ALG_SHA256}			# 256 bits long, 64 char long, 32 bytes long
# Test data
data=be3b8ba632f8d0955e06f72e0757f84ac4900bf92624dcc0490cf930c6e05e85
# Expected value in the PCR register 
# 222d771fe5fb8b36b5ea8f05cecc085917578ddbf2d34b6264b25509860f83e0
digest=${hashAlg}${data}
digests=${count}${digest}

INS=82
/echo "APDU:"
/echo "             CLA INS P1 P2 Lc             Le" 
/echo " - send:     00  82  00 00 2B TPM Command 05"
/send 00${INS}0000${cSIZE}${TAG}${cSIZE}${cCODE}${pcrHandle}${digests}05 *9000
/echo
/echo "Response:"
/echo " -  tag: ${response;s0,4}"
/echo " - size: ${response;s4,2}"
/echo " - code: ${response;s6,4}"
/echo

/echo
/echo "**************************"
/echo "* INS: 7E, Read PCR      *"
/echo "**************************"
/echo

# Command:
# **************************************************************************
# Type					Name				Description
# **************************************************************************
# TPMI_ST_COMMAND_TAG	tag	
# UINT32				commandSize	
# TPM_CC				commandCode			TPM_CC_PCR_Read
# TPML_PCR_SELECTION	pcrSelectionIn		The selection of PCR to read

# TPML_PCR_SELECTION List:
# count											UINT32				number of selection structures A value of zero is allowed.
# pcrSelections[count]{:HASH_COUNT}				TPMS_PCR_SELECTION	list of selections
# TPM_RC_SIZE														response code when count is greater than the possible number of banks

# TPMS_PCR_SELECTION Structure:
# hash											TPMI_ALG_HASH		the hash algorithm associated with the selection
# sizeofSelect {PCR_SELECT_MIN:}				UINT8				the size in octets of the pcrSelect array
# pcrSelect [sizeofSelect] {:PCR_SELECT_MAX}	BYTE				the bit map of selected PCR
# #TPM_RC_VALUE		

# Response:
# **************************************************************************
# Type					Name				Description
# **************************************************************************
# TPM_ST				tag					see clause 8
# UINT32				responseSize	
# TPM_RC				responseCode	
# UINT32				pcrUpdateCounter	the current value of the PCR update counter
# TPML_PCR_SELECTION	pcrSelectionOut		the PCR in the returned list
# TPML_DIGEST			pcrValues			the contents of the PCR indicated in pcrSelect as tagged digests

# TPM command:
TAG=${TPM_ST_NO_SESSIONS}
cSIZE=0D
TPM_CC=0000017E 
cCODE=${TPM_CC}

# TPML_PCR_SELECTION List:
count=01
hashAlg=${TPM_ALG_SHA256}
sizeofSelect=02 					# size, always 2 octets of pcrSelect array, we have 16 PCR registers
pcrSelect=0001 						# select only PCR01, octed 0 bit 1

INS=7E
/echo "APDU:"
/echo "             CLA INS P1 P2 Lc             Le" 
/echo " - send:     00  7E  00 00 0D TPM Command 28"
/send 00${INS}0000${cSIZE}${TAG}${cSIZE}${cCODE}${count}${hashAlg}${sizeofSelect}${pcrSelect}28 *9000
/echo
/echo "Response:"
/echo " -     tag: ${response;s0,4}"
/echo " -    size: ${response;s4,2}"
/echo " -    code: ${response;s6,4}"
/echo " - counter: ${response;s10,2}"
/echo " - pcr sel: ${response;s12,4}"
/echo " -    hash: ${response;s16,64}"
/echo

/echo
/echo "**************************"
/echo "* INS: 3D, PCR Reset     *"
/echo "**************************"
/echo

# TPM2_PCR_Reset Command
# **************************************************************************
# Type					Name			Description
# **************************************************************************
# TPMI_ST_COMMAND_TAG	tag	
# UINT32				commandSize	
# TPM_CC				commandCode		TPM_CC_PCR_Reset {NV}
# TPMI_DH_PCR			@pcrHandle		the PCR to reset
# 										Auth Index: 1
# 										Auth Role: USER

# TPM2_PCR_Reset Response
# **************************************************************************
# Type					Name			Description
# **************************************************************************
# TPM_ST				tag				see clause 8
# UINT32				responseSize	
# TPM_RC				responseCode	

# TPM command:
TAG=${TPM_ST_NO_SESSIONS}	# 2
cSIZE=08					# 1
TPM_CC=0000013D				# 4
cCODE=${TPM_CC}
pcrHandle=01				# 1

INS=3D
/echo "APDU:"
/echo "             CLA INS P1 P2 Lc             Le" 
/echo " - send:     00  3D  00 00 0D TPM Command 05"
/send 00${INS}0000${cSIZE}${TAG}${cSIZE}${cCODE}${pcrHandle}05 *9000
/echo
/echo "Response:"
/echo " -     tag: ${response;s0,4}"
/echo " -    size: ${response;s4,2}"
/echo " -    code: ${response;s6,4}"
